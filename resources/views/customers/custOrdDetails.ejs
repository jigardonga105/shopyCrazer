<head>
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <style>
    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }

    .ptagCSS{
        font-size: 13px !important;
        margin: 0;
        margin-bottom: 3px;
        color: #a9a7a7;
    }

    .faIcons i{
        margin-left: 100px;
    }

    .faIcons i:nth-child(1){
        margin-left: 10px;
    }

    .progress{
        height: 5px;
    }

    .dot{
        width: 12px;
        height: 12px;
        border-radius: 30px;
        margin-top: -8.5px;
    }

    .completedIcn{
        color: #26a541;
    }

    .remainingIcn{
        color: #e9ecef !important;
    }

    .remainingDot{
        background: #e9ecef;
    }

    .completedDot{
        background: #26a541;
    }

    .cancelledDot{
        background: #ff6161;
    }

    .dot1{
        margin-left: 0%;
    }
    
    .dot2{
        margin-left: 20%;
    }
    .dot3{
        margin-left: 23.5%;
    }
    .dot4{
        margin-left: 23.5%;
    }
    .dot5{
        margin-left: 23.5%;
    }
    .dot6{
        margin-left: 88.5%;
    }

    .fn15{
        font-size: 15px !important;
    }

    #cancelled{
        color: #ff6161;
    }

  </style>
</head>

<body>
    <div class="main bg-gray-100" id="main">
        <div>
            <input type="hidden" name="order" id="order" value="<%= JSON.stringify(order) %>"/>
            <input type="hidden" name="product" id="product" value="<%= JSON.stringify(product) %>"/>
            <input type="hidden" name="feaInd" id="feaInd" value="<%= feaInd %>"/>
            <input type="hidden" name="seller" id="seller" value="<%= seller %>"/>
        </div>
        <div class="container">
            <div class="flex">
                <div class="address w-10/12 bg-white border rounded" style="border-right: none !important;">
                    <h5 class="ml-2 mt-2">Delivery Address:</h5>
                    <div id="ordAdd" class="ordAdd"></div>
                </div>

                <div class="payment w-full bg-white border rounded" style="border-left: none !important;">
                    <h5 class="ml-2 mt-2">Billing:</h5>
                    <hr>
                    <div class="flex">
                        <div id="pricing" class="w-full border-r-2 pr-6"></div>
                        <div class="w-full ml-6">
                            <div>
                                <h6 class="inline-block">Payment Method:</h6>
                                <span id="paymentMethod"></span>
                                <div class="my-2" style="margin-left: 25%;">
                                    <button id="payOnlAfterBtn" class="btn shadow-sm" onclick="showHideCardDetails(this)">Pay Online</button>
                                </div>
                                <div class="border p-3 bg-black text-green-500 rounded" id="cardDetailsDiv" style="display: none; border-right: none !important;border-bottom: none !important;">
                                    <h6>Credit/Debit Card:</h6>
                                    <form action="/payOnlineLater/<%= order._id %>/<%= feaInd %>/<%= product._id %>" method="post">
                                        <div class="flex">
                                            <div>
                                                <div>
                                                    <label for="cardHoldName" class="block text-white" style="font-size: 13px !important;">Card Holder Name</label>
                                                    <input type="text" name="cardHoldName" id="cardHoldName" class="w-60 h-9 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg block p-2.5 dark:placeholder-gray-400 focus:outline-none" placeholder="name" required>
                                                </div>
                                                <div>
                                                    <label for="cardNum" class="block text-white" style="font-size: 13px !important;">Card Number</label>
                                                    <input type="number" name="cardNum" id="cardNum" class="w-60 h-9 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg block p-2.5 dark:placeholder-gray-400 focus:outline-none" placeholder="____/____/____/____" required>
                                                </div>
                                                <div>
                                                    <label for="expMonth" class="block text-white" style="font-size: 13px !important;">Expiry Month</label>
                                                    <input type="month" name="expMonth" id="expMonth" class="w-60 h-9 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg block p-2.5 dark:placeholder-gray-400 focus:outline-none" placeholder="1-12" required>
                                                </div>
                                                <div>
                                                    <label for="cvv" class="block text-white" style="font-size: 13px !important;">CVV</label>
                                                    <input type="number" name="cvv" id="cvv" class="w-60 h-9 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg block p-2.5 dark:placeholder-gray-400 focus:outline-none" placeholder="ex. 123" required>
                                                </div>
                                            </div>
                                                
                                            <div class="my-auto ml-5">
                                                <button class="bg-yellow-300 text-black px-3 py-1 mt-3 rounded focus:outline-none">Pay</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container" id="orderProgress"></div>
    </div>
    <script>
        let orderInp = document.getElementById("order");
        let productInp = document.getElementById("product");
        let feaIndInp = document.getElementById("feaInd");
        let sellerInp = document.getElementById("seller");
        let order = JSON.parse(orderInp.value);
        let product = JSON.parse(productInp.value);
        let feaInd = feaIndInp.value;
        let seller = sellerInp.value;

        let cardDetailsDiv = document.getElementById("cardDetailsDiv");
        const showHideCardDetails = (btn) => {
        if(btn.innerHTML === "Pay Online"){
            btn.innerHTML = "Pay on Delivery";
            cardDetailsDiv.style.display = "block";
        }else{
            btn.innerHTML = "Pay Online";
            cardDetailsDiv.style.display = "none";
        }
        }

        let ordAddDiv = document.getElementById("ordAdd");
        let address = JSON.parse(order.address);
        ordAddDiv.innerHTML = `<div class="flex p-3">
                                <label class="form-check-label ml-3" for="flexRadioDefault1">
                                    <div class="mt-3 inline-block"> <span class="bg-gray-500 p-1 rounded font-bold text-white">${address['add-type']}</span> </div>
                                    <div class="inline-block"> <span class="font-medium" style="font-size: 17px;">${address['add-name']}</span> </div>
                                    <div class="inline-block ml-52"> <button id="chgAddBtn" class="btn shadow-sm">Change</button> </div>
                                    <div class="my-2">
                                        <div> <span class="leading-loose" style="font-size: 14px;">${address['add-area&street']}</span> </div>
                                        <div> <span class="leading-loose" style="font-size: 14px;">${address['add-landmark'] ? address['add-landmark'] + '-' : ''}${address['add-locality']}</span> </div>
                                        <div> <span class="leading-loose" style="font-size: 14px;">${address['add-city']} ${address['add-state']}-${address['add-pin']}</span> </div>
                                    </div>
                                    <div> <span class="leading-loose" style="font-size: 14px;"><strong>Phone Number: </strong>${address['add-phone']}${address['add-altphone'] ? ' / ' + address['add-altphone'] : ''}</span> </div>
                                    <div> <button id="chgAddBtn" class="btn shadow-sm" style="font-size: 12px;color: blue;">Change</button> </div>
                                </label>
                            </div>`;
    
        //============================================================
        //============================================================

        let pricing = document.getElementById("pricing");
        let qty = 0;
        let price = 0;
        let totalDiscount = 0;
        let totalAmount = 0;
        for (const key in order.items) {
            let feature = order.items[key].feature;

            feature.map((obj) => {
                qty += obj.qty;
                price += obj.price;

                totalDiscount += ([obj.price / 100] * obj.discount) * obj.qty
            })

        }
        totalAmount = price - totalDiscount;

        price = Math.round(price);
        totalDiscount = Math.round(totalDiscount);
        totalAmount = Math.round(totalAmount);

        pricing.innerHTML = `<div class="p-3 border-b">
                                <span class="text-muted">PRICE DETAILS</span>
                                <span class="text-muted float-right">Amount</span>
                            </div>
            
                            <div class="m-3 border-b-4 border-dotted">
                                <div class="my-3">
                                    <span id="rightDivPriceItem">Price (${qty})</span>
                                    <span id="rightDivPrice" class="float-right">₹ ${price}</span>
                                </div>
                                <div class="my-3">
                                    <span>Discount</span>
                                    <span id="rightDivDisc" class="float-right text-green-600">- ₹ ${totalDiscount}</span>
                                </div>
                                <div class="my-3">
                                    <span>Delivery Charges</span>
                                    <span class="float-right text-green-600">Free</span>
                                </div>
                            </div>
            
                            <div class="m-3 border-b-4 border-dotted">
                                <div class="my-3">
                                    <span>Total Amount</span>
                                    <span id="rightDivFinalPrice" class="float-right font-bold">₹ ${totalAmount}</span>
                                </div>
                            </div>
            
                            <div class="m-3">
                                <div class="my-3">
                                    <span id="rightDivSavePrice" class="text-green-700 font-bold">You've saved ₹ ${totalDiscount} on this order</span>
                                </div>
                            </div>`;
    
        //============================================================
        //============================================================

        let paymentMethod = document.getElementById("paymentMethod");
        let payOnlAfterBtn = document.getElementById("payOnlAfterBtn");
        let paymentStatus = order.paymentStatus;
        if(paymentStatus){
            paymentMethod.innerHTML = `Online`;
            payOnlAfterBtn.style.display = "none";
        }else{
            paymentMethod.innerHTML = `Cash on Delivery`;
            payOnlAfterBtn.style.display = "block";
        }

        //============================================================
        //============================================================

        let orderProgress = document.getElementById("orderProgress");
        let featureData;

        for (const key in order.items) {
            if(key == product._id){
                let feaObj = order.items[key].feature
                feaObj.map((feature, ind) => {
                    if(ind == feaInd){
                        featureData = feature;
                    }
                })
            }
        }

        orderProgress.innerHTML = `<div class="cursor-pointer mt-3">
                                    <div class="flex flex-row bg-white border px-3 py-2 mb-2" style="padding-top: 25px !important;">
                                        <a href="/productview/${product._id}" style="color: black;" class="flex flex-row">
                                            <div class="inline-block mr-10">
                                                <img src="/../../uploadedImages/${product.image[0].img}" class="w-24" alt="img" style="margin: 50% auto;">
                                            </div>
                                            <div class="inline-block mr-10" style="width: 300px;">
                                                <h6 class="text-sm"><strong>${product.name}</strong></h6>
                                                <p class="ptagCSS">
                                                    <span class="mr-5">Color: ${featureData.color}</span>
                                                    <span class="mr-5">Size: ${featureData.size}</span>
                                                    <span class="mr-5">Quantity: ${featureData.qty}</span>
                                                </p>
                                                <p class="ptagCSS">Seller: ${seller}</p>
                                                <p class=""><strong>₹ ${Math.round(product.price - [(product.price/100) * product.discount])}</strong></p>
                                            </div>
                                        </a>
                                        <div class="inline-block">
                                            <div>
                                                <div class="flex flex-col">
                                                    <div class="faIcons relative">
                                                        <i id="placed" class="remainingIcn fa-solid fa-2x fa-clipboard"></i>
                                                        <i id="confirmed" class="remainingIcn fa-solid fa-2x fa-check-double"></i>
                                                        <i id="shipped" class="remainingIcn fa-solid fa-2x fa-truck-fast"></i>
                                                        <i id="delivery" class="remainingIcn fa-solid fa-2x fa-motorcycle"></i>
                                                        ${order.status != "cancelled" ? 
                                                        `<i id="completed" class="remainingIcn fa-solid fa-2x fa-hand-holding-heart"></i>` : 
                                                        `<i id="cancelled" class="fa-solid fa-2x fa-xmark float-right"></i>`}
                                                    </div>
                                                    <div id="pgBarContainer" style="width: 94%; margin-left: 21px; margin-top: 20px;">
                                                        <div id="progress" class="progress">
                                                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="background-color: #26a541;"></div>
                                                        </div>
                                                        <div class="flex">
                                                            <div id="placedDot" class="dot dot1 remainingDot"></div>
                                                            <div id="confirmedDot" class="dot dot2 remainingDot"></div>
                                                            <div id="shippedDot" class="dot dot3 remainingDot"></div>
                                                            <div id="deliveryDot" class="dot dot4 remainingDot"></div>
                                                            ${order.status != "cancelled" ? 
                                                            `<div id="completedDot" class="dot dot5 remainingDot"></div>` : 
                                                            `<div id="cancelledDot" class="dot dot6"></div>`}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <!--<div class="flex dateDiv">
                                                        <div id="placedDate" class="hide mt-10 bg-gray-100 fn15 rounded-full p-1"></div>
                                                        <div id="confirmedDate" class="hide mt-10 bg-gray-100 fn15 rounded-full p-1"></div>
                                                        <div id="shippedDate" class="hide mt-10 bg-gray-100 fn15 rounded-full p-1"></div>
                                                        <div id="deliveryDate" class="hide mt-10 bg-gray-100 fn15 rounded-full p-1"></div>
                                                        <div id="completedDate" class="hide mt-10 bg-gray-100 fn15 rounded-full p-1"></div>
                                                    </div>-->
                                                <div class="updatedAt">
                                                    <div class="mt-10">
                                                        <strong>Last Updated At:</strong> <span id="fillUpdateData" class="bg-gray-100 fn15 rounded-full px-3 py-1 font-black"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        ${order.status == "cancelled" ? `` : 
                                            `<div class="inline-block ml-10">
                                                <form action="/cancelOrd/${order._id}/${feaInd}/${product._id}" method="post">
                                                    <div>
                                                        <i class="fa-solid fa-xmark" style="color: red;"></i>
                                                        <button type="submit">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>`}
                                    </div>
                                </div>`;

        let progBar = document.getElementById("progress-bar");
        let idArrI = ["placed", "confirmed", "shipped", "delivery", "completed"];
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        let month = months[new Date(order.updatedAt).getMonth()];
        let date = new Date(order.updatedAt).getDate();
        let year = new Date(order.updatedAt).getFullYear();
        let hour = new Date(order.updatedAt).getHours();
        let minute = new Date(order.updatedAt).getMinutes();

        let fillUpdateData = document.getElementById("fillUpdateData");
        fillUpdateData.innerHTML = `${month} ${date}, ${year} - ${hour}:${minute}`;

        let progressBar = document.getElementById("progress-bar");

        const makeDivColored = (index) => {
            if(order.status == "cancelled"){
                let progress = document.getElementById("progress");
                progress.style.width = "96%";

                let cancelledI = document.getElementById("cancelled");
                let cancelledDot = document.getElementById("cancelledDot");

                cancelledI.style.color = "#ff6161";
                cancelledDot.classList.add("cancelledDot");

                progressBar.style.background = "#ff6161";

                idArrI.map((id, i) => {
                if(id == "placed"){
                    let favI = document.getElementById(id);
                    let favDot = document.getElementById(`${id}Dot`);

                    favI.classList.remove("remainingIcn");
                    favDot.classList.remove("remainingDot");
                    favDot.classList.add("cancelledDot");

                    favI.style.color = "#ff6161";
                    favDot.style.color = "#ff6161";
                }else{
                    let favI = document.getElementById(id);
                    let favDot = document.getElementById(`${id}Dot`);

                    if(favI){
                        favI.style.display = "none";
                        favDot.style.display = "none";
                    }

                }
            });
            }else{
                idArrI.map((id, i) => {
                    if(i <= index){
                        let favI = document.getElementById(id);
                        let favDot = document.getElementById(`${id}Dot`);

                        favI.classList.remove("remainingIcn");
                        favI.classList.add("completedIcn");
                        
                        favDot.classList.remove("remainingDot");
                        favDot.classList.add("completedDot");
                    }
                });
            }
        }

        const pgBarEditFunc = (width, index) => {
            let www = 0;
            const setInt = setInterval(() => {
                progBar.style.width = `${www}%`;

                if(www === width){
                    clearInterval(setInt);
                }else{
                    www++;
                    if (www === 1) {
                        let i = 0;
                        makeDivColored(i);
                    }else if (www === 40) {
                        let i = 1;
                        makeDivColored(i);
                    }else if (www === 65) {
                        let i = 2;
                        makeDivColored(i);
                    }else if (www === 86) {
                        let i = 3;
                        makeDivColored(i);
                    }else if (www === 100) {
                        let i = 4;
                        makeDivColored(i);
                    }
                }
            }, order.status != "cancelled" ? 50 : 20);
        }

        if(order.status == 'placed'){
            let width = 12;
            pgBarEditFunc(width);

        }else if(order.status == 'confirmed'){
            let width = 37;
            pgBarEditFunc(width);

        }else if(order.status == 'shipped'){
            let width = 62;
            pgBarEditFunc(width);

        }else if(order.status == 'delivery'){
            let width = 86;
            pgBarEditFunc(width);
        }else if(order.status == 'completed'){
            let width = 100;
            pgBarEditFunc(width);
        }else if(order.status == 'cancelled'){
            let width = 100;
            pgBarEditFunc(width);
        }
    </script>
</body>
